<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Inputs</title>
    <script src="libs/react.js"></script>
    <script src="libs/JSXTransformer.js"></script>
    <script src="libs/jquery.min.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">
      var Input = React.createClass({
        getInitialState: function() {
          return {data: {}};
        },
        componentDidMount: function() {
          this.loadFromServer();
          setInterval(this.loadFromServer, 2000);
        },
        loadFromServer: function() {
          $.post("/HSA/execute?name=io.1wire&msg=get_input_value",
            '<hsd><p n="input" t="l">' + this.props.inputId + '</p></hsd>') 
          .done(function(xmlData){
            var parsedData = {};
            $(xmlData).find("p").each(function(){
              if ($(this).attr("n") == "time"){
                parsedData["time"] = new Date($(this).text() * 1000).toLocaleString();
              } else {
                parsedData[$(this).attr("n")] = $(this).text();
              }
            });
            this.setState({data: parsedData});
          }.bind(this));
        },
        render: function() {
          return (
            <div className="input">
              <div className="inputId">
                {this.props.inputId}
              </div>
              <h3 className="inputValue">
                {this.state.data.value}
              </h3>
              <div className="inputTime">
                {this.state.data.time}
              </div>
            </div>
          );
        }
      });
      var InputsBox = React.createClass({
        getInitialState: function() {
          return {data: []};
        },
        componentDidMount: function() {
          this.loadFromServer();
          setInterval(this.loadFromServer, 10000);
        },
        loadFromServer: function() {
          jQuery.get("/HSA/execute?name=io.1wire&msg=get_inputs")
          .done(function(xmlData){
            var data = $(xmlData).find("e").toArray().map(function(elem){
              return $(elem).text();
            });
            data.sort();
            this.setState({data: data});
          }.bind(this));
        },
        render: function() {
          var inputNodes = this.state.data.map(function(input) {
            return (
              <Input inputId={input}>
              </Input>
            );
          });
          return (
            <div className="inputsBox">
              {inputNodes}
            </div>
          );
        }
      });
      React.render(
        <InputsBox />,
        document.getElementById('content')
      );
    </script>
  </body>
</html>